global  class RESTCentreCityMasterBatch implements Database.Batchable<sObject>,   Database.AllowsCallouts{
    
    public String query = 'SELECT ID, Name, City_Code__c FROM Centre_City__c';
    global Database.QueryLocator start(Database.BatchableContext BC) {
        return Database.getQueryLocator(query);
    }
    global void execute(Database.BatchableContext BC, List<Centre_City__c> records) { 
        
        
        String js = '';
        String s = '';
        Http h = new Http();		
        HttpRequest req = new HttpRequest();
        
        req.setMethod('POST');
        req.setBody(js);
        req.setTimeout(120000);
        req.setHeader('Content-type', 'application/json');
        req.setHeader('token', s);
        req.setEndpoint('http://lima.imsindia.com/MyIMS/default.aspx?action=getcentrecity');//sandbox url
        
        System.debug('The request is made to Datamatics-in Account---'+req);
        HttpResponse res = h.send(req);
        
        
        
        Map<String,Centre_City__c> stMAp = new Map<String,Centre_City__c>();
        for(Centre_City__c ct:records){
            stMAp.put(ct.City_Code__c, ct);
        }
        
        JSON2ApexCentreCity jsCity = JSON2ApexCentreCity.parse(res.getBody());
        
        List<centrecity> centrCity = new List<centrecity>();
        If(jsCity.centrecity.size()>0){
            For(Centrecity st:jsCity.centrecity){
                System.debug('I am printing --'+st);
                centrCity.add(st);
            }
        }else{
            System.debug('StudentCity is Empty');
        }
        
        
        List<Centre_City__c> updateStudList = new List<Centre_City__c>();
        List<Centre_City__c> insertStudList = new List<Centre_City__c>();
        For(centrecity st:centrCity){
            If(stMAp.containskey(st.Code)){
                Centre_City__c o = stMAp.get(st.Code);
                o.Name = st.City;
                updateStudList.add(o);
            }else{
                Centre_City__c c = new Centre_City__c();
                c.Name = st.City;
                c.City_Code__c = st.Code;
                
                insertStudList.add(c);
            }
            
        }
        System.debug('I am printing the Update List---->'+updateStudList);
        System.debug('I am printing the Insert List---->'+insertStudList);
        update updateStudList;
        insert insertStudList;
        
        
        System.debug('After preparing list for Update Print please---'+updateStudList);
        
    }
    
    global void finish(Database.BatchableContext BC){    
    }
    
     //
    // Generated by JSON2Apex http://json2apex.herokuapp.com/
    //
    
    public class JSON2ApexCentreCity {
        public List<centrecity> centrecity;
    }
    
    public class centrecity {
        public String Code;
        public String City;
    }
    
    
    
    
    public static JSON2ApexCentreCity parse(String json) {
        return (JSON2ApexCentreCity) System.JSON.deserialize(json, JSON2ApexCentreCity.class);
    }
    
    
    
}