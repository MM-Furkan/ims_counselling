global  class RESTStudentCityMasterBatch implements Database.Batchable<sObject>,   Database.AllowsCallouts{
    
    public String query = 'SELECT Id, Name, City_Code__c FROM City__c limit 10000';
    global Database.QueryLocator start(Database.BatchableContext BC) {
        return Database.getQueryLocator(query);
    }
    global void execute(Database.BatchableContext BC, List<City__c> records) { 
        
        String js = '';
        String s = '';
        Http h = new Http();		
        HttpRequest req = new HttpRequest();
        
        req.setMethod('POST');
        req.setBody(js);
        req.setTimeout(120000);
        req.setHeader('Content-type', 'application/json');
        req.setHeader('token', s);
        req.setEndpoint('http://lima.imsindia.com/MyIMS/default.aspx?action=getstudentcity');//sandbox url
        
        System.debug('The request is made to Datamatics-in Account---'+req);
        HttpResponse res = h.send(req);
        
        
        Map<String,City__c> stMAp = new Map<String,City__c>();
        for(City__c ct:records){
            stMAp.put(ct.City_Code__c, ct);
        }
        
        
        JSON2ApexStudentCity jsCity = JSON2ApexStudentCity.parse(res.getBody());
        List<studentcity> studCity = new List<studentcity>();
        If(jsCity.studentcity.size()>0){
            System.debug('The Size of jsCity.studentcity.size()---'+jsCity.studentcity.size());
            For(Studentcity st:jsCity.studentcity){
                studCity.add(st);
            }
        }else{
            System.debug('StudentCity is Empty');
        }
        
        List<City__c> updateStudList = new List<City__c>();
        List<City__c> insertStudList = new List<City__c>();
        For(studentcity st:studCity){
            If(stMAp.containskey(st.Code)){
                City__c o = stMAp.get(st.Code);
                o.Name = st.City;
                updateStudList.add(o);
            }else{
                City__c c = new City__c();
                c.Name = st.City;
                c.City_Code__c = st.Code;
                
                insertStudList.add(c);
            }
            
        }
        
        update updateStudList;
        insert insertStudList;
        
        
        System.debug('After preparing list for Update Print please---'+updateStudList);
        
        

    }
    global void finish(Database.BatchableContext BC){    
    }
    
    //
    // Generated by JSON2Apex http://json2apex.herokuapp.com/
    //
    
    public class JSON2ApexStudentCity {
        public List<Studentcity> studentcity;
    }
    
    public class Studentcity {
        public String Code;
        public String City;
    }
    
    
    
    
    public static JSON2ApexStudentCity parse(String json) {
        return (JSON2ApexStudentCity) System.JSON.deserialize(json, JSON2ApexStudentCity.class);
    }
    
    

}